<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amigo Secreto ‚Äî Sorteador com Blacklist</title>
  <style>
    :root{--bg:#0b1020;--card:#0f1724;--accent:#e11d48;--accent2:#06b6d4;--muted:#9ca3af}
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071028 0%, #071a2b 60%);color:#edf2f7}
    header{display:flex;gap:12px;align-items:center;padding:20px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .tree{width:56px;height:56px}
    h1{margin:0;font-size:20px}
    .container{max-width:980px;margin:18px auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.6)}
    label{display:block;font-size:13px;margin-bottom:8px;color:var(--muted)}
    textarea{width:100%;min-height:120px;padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,0.06);background:transparent;color:inherit;resize:vertical}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .row{display:flex;gap:10px;align-items:center}
    button{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .small{font-size:13px;padding:8px 10px}
    ul{padding-left:18px}
    .participants-list{max-height:260px;overflow:auto;margin-top:8px}
    .participant{display:flex;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.02)}
    .chip{padding:6px 9px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px}
    .links{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .token-box{display:flex;gap:8px;align-items:center}
    .result-card{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
    .reveal-name{font-size:28px;font-weight:700;margin-top:8px}
    .subtitle{color:var(--muted);font-size:13px}
    .loading{display:none;margin-top:10px;color:var(--accent);font-weight:600}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .notice{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}.logo .tree{display:none}}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <svg class="tree" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="64" height="64" rx="12" fill="#06202e"/>
        <g transform="translate(8 6)">
          <path d="M24 0L0 36h48L24 0z" fill="#10B981"/>
          <path d="M18 10l-6 8 12 0-6-8z" fill="#059669"/>
          <rect x="22" y="34" width="8" height="10" rx="1" fill="#7C2DFF"/>
          <circle cx="6" cy="18" r="2.5" fill="#FBBF24"/>
          <circle cx="34" cy="14" r="2.5" fill="#EF4444"/>
          <circle cx="18" cy="26" r="2.5" fill="#06B6D4"/>
        </g>
      </svg>
      <div>
        <h1>Amigo Secreto ‚Äî Sorteador com Blacklist</h1>
        <div class="subtitle">Gera links/token √∫nicos para cada participante. S√≥ a pessoa com o link/token v√™ o resultado.</div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <div id="editorCard" class="card">
        <label>1) Cole a lista de participantes e suas restri√ß√µes (formato: Nome: proibidos separados por v√≠rgula)</label>
        <textarea id="namesInput" placeholder="Ex:\nAna: Bruno, Carla\nBruno: Ana\nCarla:\nDiego: Ana, Bruno"></textarea>

        <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
          <button id="generateBtn">Gerar atribui√ß√µes</button>
          <button id="clearBtn" class="ghost small">Limpar</button>
          <div style="margin-left:auto;color:var(--muted);font-size:13px">Tema: üéÑ Natal</div>
        </div>
        <div id="loading" class="loading">Calculando correspond√™ncias...</div>

        <div class="notice">
          <strong>Como funciona</strong>
          <ul>
            <li>O sistema gera uma correspond√™ncia 1‚Üí1 respeitando blacklist e evitando que algu√©m tire a si mesmo.</li>
            <li>Para cada participante voc√™ recebe um <em>link</em> e um <em>token</em>. Envie em privado.</li>
            <li>Quem abrir o link ver√° apenas o seu amigo secreto.</li>
          </ul>
        </div>

        <div id="generatedArea" style="display:none;margin-top:12px">
          <label>2) C√≥pia dos links/tokens (envie em privado)</label>
          <div id="linksContainer" class="links"></div>
        </div>

      </div>

  <div id="revealCard" class="card" style="display:none">
        <div id="revealPanel">
          <label>Abrir link/token direto</label>
          <div class="row" style="gap:8px;margin-bottom:8px">
            <input id="tokenInput" type="text" placeholder="Cole token ou link aqui" />
            <button id="openTokenBtn" class="small">Abrir</button>
          </div>

          <div class="result-card card" style="margin-top:8px;">
            <div id="resultArt">üéÅ</div>
            <div id="resultText" style="margin-top:8px">
              <div class="subtitle">Seu amigo secreto aparecer√° aqui</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const el = id=>document.getElementById(id);
    function base64Encode(str){return btoa(unescape(encodeURIComponent(str)))}
    function base64Decode(b){return decodeURIComponent(escape(atob(b)))}
    function uuid(){return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{let r=Math.random()*16|0;let v=c=='x'?r:(r&0x3|0x8);return v.toString(16)})}

    function parseInput(text){
      const lines = text.trim().split('\n');
      return lines.map(l=>{
        const [name,bl] = l.split(':').map(s=>s.trim());
        const blacklist = bl ? bl.split(',').map(x=>x.trim()).filter(x=>x.length) : [];
        return {name, blacklist};
      });
    }

    function assignWithBlacklist(participants){
      console.log('Assigning with blacklist', participants);
      const n = participants.length;
      let names, tries=0, valid;
      do{
        names = participants.map(p=>p.name);
        for(let i=names.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [names[i],names[j]]=[names[j],names[i]];
        }
        valid = true;
        for(let i=0;i<n;i++){
          const from = participants[i];
          const to = names[i];
          if(to===from.name || from.blacklist.includes(to)){valid=false;break;}
        }
        tries++;
        if(tries>10000) return null;
      }while(!valid);
      return participants.map((p,i)=>({from:p.name,to:names[i]}));
    }

    // Helpers to show/hide the two cards depending on whether a token is available
    function showEditorCard(){
      const ed = el('editorCard'); const rc = el('revealCard');
      if(ed) ed.style.display = 'block';
      if(rc) rc.style.display = 'none';
    }
    function showRevealCard(){
      const ed = el('editorCard'); const rc = el('revealCard');
      if(ed) ed.style.display = 'none';
      if(rc) rc.style.display = 'block';
    }

    el('generateBtn').addEventListener('click',async ()=>{
      el('loading').style.display='block';
      await new Promise(r=>setTimeout(r,50));
      const raw = el('namesInput').value.trim();
      if(!raw){alert('Cole a lista de participantes e restri√ß√µes'); el('loading').style.display='none'; return}
      const participants = parseInput(raw);
      if(participants.length<2){alert('S√£o necess√°rios pelo menos 2 participantes.'); el('loading').style.display='none'; return}
      const assigns = assignWithBlacklist(participants);
      el('loading').style.display='none';
      if(!assigns){alert('N√£o foi poss√≠vel gerar uma atribui√ß√£o v√°lida. Verifique as restri√ß√µes.');return}
      const container = el('linksContainer'); container.innerHTML='';
      const baseUrl = (location.href.split('#')[0]);
      assigns.forEach(item=>{
        const tokenObj = {from:item.from,to:item.to,ts:Date.now(),id:uuid()};
        const token = base64Encode(JSON.stringify(tokenObj));
        const link = baseUrl + '#reveal=' + encodeURIComponent(token);
        const div = document.createElement('div'); div.className='participant';
        const left = document.createElement('div'); left.innerHTML=`<div style="font-weight:700">${escapeHtml(item.from)}</div><div class="subtitle">Envie em privado</div>`;
        const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
        const tokenBox = document.createElement('div'); tokenBox.className='token-box';
        const tokenField = document.createElement('input'); tokenField.type='text'; tokenField.value=token; tokenField.style.width='220px'; tokenField.readOnly=true;
        const copyBtn = document.createElement('button'); copyBtn.textContent='Copiar token'; copyBtn.className='small';
        const copyLinkBtn = document.createElement('button'); copyLinkBtn.textContent='Copiar link'; copyLinkBtn.className='small ghost';
        copyBtn.onclick=()=>{navigator.clipboard.writeText(token).then(()=>copyBtn.textContent='Copiado!')};
        copyLinkBtn.onclick=()=>{navigator.clipboard.writeText(link).then(()=>copyLinkBtn.textContent='Copiado!')};
        tokenBox.appendChild(tokenField); tokenBox.appendChild(copyBtn);
        right.appendChild(tokenBox); right.appendChild(copyLinkBtn);
        div.appendChild(left); div.appendChild(right);
        container.appendChild(div);
      });
      el('generatedArea').style.display='block';
    });

    el('clearBtn').addEventListener('click',()=>{el('namesInput').value=''; el('generatedArea').style.display='none'; el('linksContainer').innerHTML=''});

  el('openTokenBtn').addEventListener('click',()=>{const t=el('tokenInput').value.trim(); if(!t){alert('Cole um token ou link antes.');return} openTokenFromAny(t)});

    function openTokenFromAny(s){
      try{
        const hashIndex = s.indexOf('#reveal=');
        if(hashIndex!==-1) s = decodeURIComponent(s.slice(hashIndex+8));
        const json = JSON.parse(base64Decode(s));
        showResult(json);
        showRevealCard();
      }catch(e){alert('Token inv√°lido ou corrompido.'); console.error(e)}
    }

    (function(){
      const frag = location.hash;
      if(frag && frag.startsWith('#reveal=')){
        const token = decodeURIComponent(frag.slice(8));
        try{const json = JSON.parse(base64Decode(token)); showResult(json); showRevealCard(); return;}catch(e){console.warn(e)}
      }
      // default: no token in hash -> show editor
      showEditorCard();
    })();

    function showResult(obj){
      const art = el('resultArt'); const txt = el('resultText');
      art.innerHTML = 'üéÅ';
      txt.innerHTML = `<div class="subtitle">${escapeHtml(obj.from)}, seu amigo secreto √©:</div><div class="reveal-name">${escapeHtml(obj.to)}</div>`;
    }

    function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}
  </script>
</body>
</html>