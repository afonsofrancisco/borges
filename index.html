<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Amigo Secreto ‚Äî Sorteador</title>
  <style>
    :root{--bg:#0b1020;--card:#0f1724;--accent:#e11d48;--accent2:#06b6d4;--muted:#9ca3af}
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071028 0%, #071a2b 60%);color:#edf2f7}
    header{display:flex;gap:12px;align-items:center;padding:20px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo .tree{width:56px;height:56px}
    h1{margin:0;font-size:20px}
    .container{max-width:980px;margin:18px auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.6)}
    label{display:block;font-size:13px;margin-bottom:8px;color:var(--muted)}
    textarea{width:100%;min-height:220px;padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,0.06);background:transparent;color:inherit;resize:vertical}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .row{display:flex;gap:10px;align-items:center}
    button{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .small{font-size:13px;padding:8px 10px}
    ul{padding-left:18px}
    .participants-list{max-height:260px;overflow:auto;margin-top:8px}
    .participant{display:flex;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:6px;background:rgba(255,255,255,0.02)}
    .chip{padding:6px 9px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:13px}
    .links{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .token-box{display:flex;gap:8px;align-items:center}
    .result-card{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px;text-align:center}
    .reveal-name{font-size:28px;font-weight:700;margin-top:8px}
    .subtitle{color:var(--muted);font-size:13px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .notice{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;margin-top:12px}
    .qr{width:120px;height:120px;border-radius:8px;background:white;display:flex;align-items:center;justify-content:center;color:#111}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}.logo .tree{display:none}}
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <svg class="tree" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="64" height="64" rx="12" fill="#06202e"/>
        <g transform="translate(8 6)">
          <path d="M24 0L0 36h48L24 0z" fill="#10B981"/>
          <path d="M18 10l-6 8 12 0-6-8z" fill="#059669"/>
          <rect x="22" y="34" width="8" height="10" rx="1" fill="#7C2DFF"/>
          <circle cx="6" cy="18" r="2.5" fill="#FBBF24"/>
          <circle cx="34" cy="14" r="2.5" fill="#EF4444"/>
          <circle cx="18" cy="26" r="2.5" fill="#06B6D4"/>
        </g>
      </svg>
      <div>
        <h1>Amigo Secreto ‚Äî Sorteador</h1>
        <div class="subtitle">Gera links/token √∫nicos para cada participante. S√≥ a pessoa com o link/token v√™ o resultado.</div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card">
        <label>1) Cole a lista de participantes (um por linha)</label>
        <textarea id="namesInput" placeholder="Ex:\nAna\nBruno\nCarla\nDiego"></textarea>

        <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
          <button id="generateBtn">Gerar atribui√ß√µes</button>
          <button id="clearBtn" class="ghost small">Limpar</button>
          <div style="margin-left:auto;color:var(--muted);font-size:13px">Tema: üéÑ Natal</div>
        </div>

        <div class="notice">
          <strong>Como funciona</strong>
          <ul>
            <li>O sistema gera uma correspond√™ncia 1‚Üí1 sem que ningu√©m tire o pr√≥prio nome.</li>
            <li>Para cada participante voc√™ recebe um <em>link</em> e um <em>token</em>. Envie um privado a cada pessoa.</li>
            <li>Quem abrir o link (ou colar o token na p√°gina) ver√° apenas o pr√≥prio amigo secreto.</li>
          </ul>
        </div>

        <div id="generatedArea" style="display:none;margin-top:12px">
          <label>2) C√≥pia dos links/tokens (envie em privado)</label>
          <div id="linksContainer" class="links"></div>
          <div style="margin-top:10px;color:var(--muted);font-size:13px">Dica: copie o token e cole numa mensagem privada. O link tamb√©m funciona se voc√™ hospedar este arquivo online.</div>
        </div>

      </div>

      <div class="card">
        <div id="revealPanel">
          <label>Abrir link direto</label>
          <div class="row" style="gap:8px;margin-bottom:8px">
            <input id="tokenInput" type="text" placeholder="Cole token ou link aqui" />
            <button id="openTokenBtn" class="small">Abrir</button>
          </div>

          <div class="result-card card" style="margin-top:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))">
            <div id="resultArt">üéÅ</div>
            <div id="resultText" style="margin-top:8px">
              <div class="subtitle">Seu amigo secreto aparecer√° aqui</div>
            </div>
          </div>

          <footer>
            <div>Recomenda√ß√µes:</div>
            <ul>
              <li>N√£o envie os links/token em grupo ‚Äî mande em privado.</li>
              <li>Se preferir hosped√°-lo, fa√ßa upload do arquivo <code>amigo-secreto.html</code> no GitHub Pages ou similar.</li>
            </ul>
          </footer>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Utilities
    const el = id=>document.getElementById(id);
    function base64Encode(str){return btoa(unescape(encodeURIComponent(str)))}
    function base64Decode(b){return decodeURIComponent(escape(atob(b)))}
    function uuid(){return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{let r=Math.random()*16|0;let v=c=='x'?r:(r&0x3|0x8);return v.toString(16)})}

    // Derangement: shuffle until no fixed point (works fine for n>1)
    function derangement(arr){
      const n=arr.length; if(n===1) return null;
      let perm = arr.map((_,i)=>i);
      for(let attempts=0;attempts<10000;attempts++){
        // Fisher-Yates
        for(let i=n-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [perm[i],perm[j]]=[perm[j],perm[i]];
        }
        let ok=true; for(let i=0;i<n;i++) if(perm[i]===i){ok=false;break}
        if(ok) return perm;
      }
      return null; // failed
    }

    // When generate
    el('generateBtn').addEventListener('click',()=>{
      const raw = el('namesInput').value.trim();
      if(!raw){alert('Cole a lista de participantes (um por linha)');return}
      const names = raw.split('\n').map(s=>s.trim()).filter(s=>s.length);
      const n = names.length;
      if(n<2){alert('S√£o necess√°rios pelo menos 2 participantes.');return}
      const perm = derangement(names);
      if(!perm){alert('N√£o foi poss√≠vel gerar uma atribui√ß√£o sem conflitos. Tente novamente.');return}
      // build assignments
      const assigns = names.map((from,i)=>({from, to:names[perm[i]]}));
      // display links / tokens
      const container = el('linksContainer'); container.innerHTML='';
      const baseUrl = (location.href.split('#')[0]);
      assigns.forEach(item=>{
        const tokenObj = {from:item.from,to:item.to,ts:Date.now(),id:uuid()};
        const token = base64Encode(JSON.stringify(tokenObj));
        const link = baseUrl + '#reveal=' + encodeURIComponent(token);
        // element
        const div = document.createElement('div'); div.className='participant';
        const left = document.createElement('div'); left.innerHTML=`<div style="font-weight:700">${escapeHtml(item.from)}</div><div class="subtitle">Envie em privado</div>`;
        const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end';
        const tokenBox = document.createElement('div'); tokenBox.className='token-box';
        const tokenField = document.createElement('input'); tokenField.type='text'; tokenField.value=token; tokenField.style.width='220px'; tokenField.readOnly=true;
        const copyBtn = document.createElement('button'); copyBtn.textContent='Copiar token'; copyBtn.className='small';
        const copyLinkBtn = document.createElement('button'); copyLinkBtn.textContent='Copiar link'; copyLinkBtn.className='small ghost';
        copyBtn.onclick=()=>{navigator.clipboard.writeText(token).then(()=>copyBtn.textContent='Copiado!')};
        copyLinkBtn.onclick=()=>{navigator.clipboard.writeText(link).then(()=>copyLinkBtn.textContent='Copiado!')};
        tokenBox.appendChild(tokenField); tokenBox.appendChild(copyBtn);
        right.appendChild(tokenBox); right.appendChild(copyLinkBtn);
        div.appendChild(left); div.appendChild(right);
        container.appendChild(div);
      });
      el('generatedArea').style.display='block';
      // show small preview of assignments (only for organizer)
      showOrganizerPreview(assigns);
    });

    el('clearBtn').addEventListener('click',()=>{el('namesInput').value=''; el('generatedArea').style.display='none'; el('linksContainer').innerHTML=''; el('previewList')&&el('previewList').remove()});

    // Open token from input or from URL
    el('openTokenBtn').addEventListener('click',()=>{const t=el('tokenInput').value.trim(); if(!t){alert('Cole um token ou link antes.');return} openTokenFromAny(t)});

    function openTokenFromAny(s){
      try{
        // if full link with #reveal=...
        const hashIndex = s.indexOf('#reveal=');
        if(hashIndex!==-1) s = decodeURIComponent(s.slice(hashIndex+8));
        // if it's a URL that includes ? or others, try extract
        if(s.includes('%7B') || s.includes('%22')) s = decodeURIComponent(s);
        const json = JSON.parse(base64Decode(s));
        showResult(json);
      }catch(e){alert('Token inv√°lido ou corrompido. Certifique-se de colar o token/link completo.');console.error(e)}
    }

    // On page load: check URL fragment
    (function(){
      const frag = location.hash;
      if(frag && frag.startsWith('#reveal=')){
        const token = decodeURIComponent(frag.slice(8));
        try{const json = JSON.parse(base64Decode(token)); showResult(json);}
        catch(e){console.warn('N√£o foi poss√≠vel decodificar o token na URL',e)}
      }
    })();

    function showResult(obj){
      const art = el('resultArt'); const txt = el('resultText');
      art.innerHTML = `
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2l3 6h6l-4.8 3.5L20 20l-8-5-8 5 1.8-8.5L1 8h6l3-6z" fill="#FBBF24"/>
        </svg>`;
      txt.innerHTML = `<div class="subtitle">${escapeHtml(obj.from)}, seu amigo secreto √©:</div><div class="reveal-name">${escapeHtml(obj.to)}</div>`;
      // confetti? lightweight
      joy();
    }

    function showOrganizerPreview(assigns){
      // small hidden preview list so organizer can check
      const container = el('linksContainer');
      const preview = document.createElement('div'); preview.id='previewList'; preview.style.marginTop='12px';
      preview.innerHTML = '<label>Pr√©-visualiza√ß√£o (apenas organizador)</label>';
      const list = document.createElement('div'); list.className='participants-list';
      assigns.forEach(a=>{const row=document.createElement('div');row.className='participant';row.innerHTML=`<div>${escapeHtml(a.from)}</div><div class="chip">‚Üí ${escapeHtml(a.to)}</div>`;list.appendChild(row)});
      preview.appendChild(list); container.appendChild(preview);
    }

    function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]))}

    // little celebration
    function joy(){
      // simple falling stars
      for(let i=0;i<18;i++){
        const p=document.createElement('div');
        p.style.position='fixed'; p.style.left=(Math.random()*100)+'%'; p.style.top='-20px'; p.style.zIndex=9999;
        p.style.fontSize=(8+Math.random()*18)+'px'; p.style.opacity=Math.random(); p.textContent=['‚ú®','üéÑ','üéÅ','‚ùÑÔ∏è'][Math.floor(Math.random()*4)];
        document.body.appendChild(p);
        const dur=2000+Math.random()*1800;
        p.animate([{transform:'translateY(0) rotate(0deg)'},{transform:`translateY(${window.innerHeight+40}px) rotate(${Math.random()*360}deg)`}],{duration:dur,iterations:1,easing:'linear'}).onfinish=()=>p.remove();
      }
    }

    // helper: if user pasted a full URL at load, try decode
    window.addEventListener('paste', (e)=>{
      try{
        const text = (e.clipboardData||window.clipboardData).getData('text');
        if(text && text.includes('#reveal=')){
          // prefill token input
          el('tokenInput').value = text;
        }
      }catch(e){}
    });

  </script>
</body>
</html>
